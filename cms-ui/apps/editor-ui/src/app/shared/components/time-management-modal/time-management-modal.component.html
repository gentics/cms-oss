<div class="modal-title">
  <h5 [attr.data-pageName]="item?.name">{{ 'modal.time_management_title' | gtxI18n:{ itemName: item?.name } }}</h5>
</div>

<ng-template #dateDisplay let-value="value">
  <div
    class="date-display"
    [class.has-date]="value > 0"
    >
    {{ !value ? ('modal.time_management_date_not_set' | gtxI18n) : (value | gtxI18nDate:'dateTime')}}
  </div>
</ng-template>

<div class="modal-content">
  @if (item && (item?.timeManagement?.at > 0 || item?.timeManagement?.offlineAt > 0 || timeMgmtQueuedRequestsExists())) {
    <div
      class="section"
      >
      <h2 class="section-title">{{ 'modal.time_management_current_settings_label' | gtxI18n }}</h2>
      <div class="split">
        <div
          class="split-entry"
          data-entry="existing-publish-at"
          [attr.data-value]="item?.timeManagement?.at"
          [attr.data-version]="existingPublishAtVersion"
          >
          <h3 class="split-title">{{ (item.type === 'page' ? 'modal.publish_at' : 'modal.publish_form_at') | gtxI18n }}</h3>
          <ng-container *ngTemplateOutlet="dateDisplay; context: { value: item?.timeManagement?.at }"></ng-container>
          @if (hasExistingPublishAt) {
            <detail-chip>
              {{ 'modal.time_version_label' | gtxI18n:{ version: existingPublishAtVersion } }}
            </detail-chip>
          }
        </div>
        <div
          class="split-entry"
          data-entry="existing-offline-at"
          [attr.data-value]="item?.timeManagement?.offlineAt"
          >
          <h3 class="split-title">{{ (item.type === 'page' ? 'modal.take_offline_at' : 'modal.take_form_offline_at') | gtxI18n }}</h3>
          <ng-container *ngTemplateOutlet="dateDisplay; context: { value: item?.timeManagement?.offlineAt }"></ng-container>
        </div>
      </div>
    </div>
  }

  @if (item && timeMgmtQueuedRequestsExists()) {
    <div class="section timemgmt-queue">
      <h2 class="section-title">{{ 'editor.publish_queue_label' | gtxI18n }}</h2>
      <div class="split">
        <div
          class="split-entry"
          data-entry="queued-publish"
          [attr.data-value]="item?.timeManagement?.queuedPublish?.at"
          [attr.data-first-name]="item?.timeManagement?.queuedPublish?.user?.firstName"
          [attr.data-last-name]="item?.timeManagement?.queuedPublish?.user?.lastName"
          >
          @if (item.timeManagement.queuedPublish) {
            <h3 class="split-title">{{ (item.type === 'page' ? 'modal.publish_at' : 'modal.publish_form_at') | gtxI18n }}</h3>
            <div class="queue-info">
              {{ getFormattedTimeMgmtValue('queuedPublish') | async }}
            </div>
          }
        </div>
        <div
          class="split-entry"
          data-entry="queued-offline"
          [attr.data-value]="item?.timeManagement?.queuedOffline?.at"
          [attr.data-first-name]="item?.timeManagement?.queuedOffline?.user?.firstName"
          [attr.data-last-name]="item?.timeManagement?.queuedOffline?.user?.lastName"
          >
          @if (item.timeManagement.queuedOffline) {
            <h3 class="split-title">{{ (item.type === 'page' ? 'modal.take_offline_at' : 'modal.take_form_offline_at') | gtxI18n }}</h3>
            <div class="queue-info">
              {{ getFormattedTimeMgmtValue('queuedOffline') | async }}
            </div>
          }
        </div>
      </div>
    </div>
  }

  <div class="section">
    <h2 class="section-title">{{ 'modal.time_management_override_label' | gtxI18n }}</h2>

    <gtx-radio-group
      data-control="version"
      [attr.data-value]="versionSelect"
      [(ngModel)]="versionSelect"
      (valueChange)="updateFormValidity()"
      >
      @if (keepVersionVisible) {
        <gtx-radio-button
          class="version-select"
          data-control="existing_version"
          [attr.data-value]="existingItemVersion"
          [value]="VersionManagement.KEEP_VERSION"
          [label]="'modal.time_version_label' | gtxI18n:{ version: existingItemVersion }"
        ></gtx-radio-button>
      }

      @if (keepVersionVisible) {
        <div class="split">
          <gtx-date-time-picker
            class="split-entry"
            data-control="existing_publishAt"
            [label]="(item.type === 'page' ? 'modal.publish_at' : 'modal.publish_form_at') | gtxI18n"
            [disabled]="!userHasPublishPermission || versionSelect !== VersionManagement.KEEP_VERSION"
            [clearable]="true"
            [(ngModel)]="existingPublishAt"
            (valueChange)="updateFormValidity('publishAt')"
          ></gtx-date-time-picker>
          <gtx-date-time-picker
            class="split-entry"
            data-control="existing_offlineAt"
            [label]="(item.type === 'page'? 'modal.take_offline_at' : 'modal.take_form_offline_at') | gtxI18n"
            [disabled]="!userHasPublishPermission || versionSelect !== VersionManagement.KEEP_VERSION"
            [clearable]="true"
            [(ngModel)]="existingTakeOfflineAt"
            (valueChange)="updateFormValidity('takeOfflineAt')"
          ></gtx-date-time-picker>
        </div>
      }

      @if (keepVersionVisible) {
        <gtx-radio-button
          class="version-select"
          data-control="current_version"
          [attr.data-value]="latestItemVersion"
          [value]="VersionManagement.NEW_VERSION"
          [label]="'modal.time_management_publish_keep_version' | gtxI18n:{ version: latestItemVersion }"
          [attr.data-pageOrFormVersionLatest]="latestItemVersion"
        ></gtx-radio-button>
      }

      <div class="split">
        <gtx-date-time-picker
          class="split-entry"
          data-control="current_publishAt"
          [label]="((item.type === 'page' ? 'modal.publish_at' : 'modal.publish_form_at') | gtxI18n) + (keepVersionVisible && !(takeOfflineAt > 0) ? '*' : '')"
          [disabled]="versionSelect !== VersionManagement.NEW_VERSION"
          [required]="keepVersionVisible && !(takeOfflineAt > 0)"
          [clearable]="true"
          [(ngModel)]="publishAt"
          (valueChange)="updateFormValidity('publishAt')"
        ></gtx-date-time-picker>

        <gtx-date-time-picker
          class="split-entry"
          data-control="current_offlineAt"
          [label]="((item.type === 'page'? 'modal.take_offline_at' : 'modal.take_form_offline_at') | gtxI18n) + (keepVersionVisible && !(publishAt > 0) ? '*' : '')"
          [disabled]="versionSelect !== VersionManagement.NEW_VERSION"
          [required]="keepVersionVisible && !(publishAt > 0)"
          [clearable]="true"
          [(ngModel)]="takeOfflineAt"
          (valueChange)="updateFormValidity('takeOfflineAt')"
        ></gtx-date-time-picker>
      </div>

      @if (keepVersionVisible && versionSelect === VersionManagement.NEW_VERSION) {
        <p
          class="timemgmt-form-warning"
          >{{ 'modal.time_management_keep_version_warning' | gtxI18n:{
          version: existingPublishAtVersion
        } }}</p>
      }
    </gtx-radio-group>
  </div>

  @if (itemsToBeModified.length > 1) {
    <div
      class="section"
      [class.none-selected]="selectedLanguageVariants[item.id]?.length === 0"
      >
      <h2 class="section-title">{{ 'modal.time_management_apply_languages' | gtxI18n }}</h2>
      <page-language-selector
        class="language-selector"
        data-control="languages"
        [page]="item"
        [variants]="itemsToBeModified"
        [selected]="selectedLanguageVariants[item.id]"
        (selectionChange)="onLanguageSelectionChange(item.id, $event)"
      ></page-language-selector>
    </div>
  }
</div>

<div class="modal-footer">
  <gtx-button
    flat
    type="secondary"
    data-action="cancel"
    (click)="cancelFn()"
  >{{ 'common.cancel_button' | gtxI18n }}</gtx-button>

  <gtx-button
    data-action="confirm"
    [disabled]="!formValid"
    (click)="btnOkayClicked()"
  >{{ 'common.okay_button' | gtxI18n }}</gtx-button>
</div>
